<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escrow Trust Model Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0d1117;
      color: #c9d1d9;
      overflow: hidden;
    }

    #container {
      display: flex;
      height: 100vh;
    }

    #sidebar {
      width: 350px;
      background: #161b22;
      border-right: 1px solid #30363d;
      overflow-y: auto;
      padding: 20px;
    }

    #graph {
      flex: 1;
      position: relative;
    }

    h1 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #58a6ff;
    }

    h2 {
      font-size: 14px;
      margin: 16px 0 8px 0;
      color: #8b949e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-box {
      background: #21262d;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      font-size: 13px;
    }

    .summary-row.total {
      border-top: 1px solid #30363d;
      margin-top: 8px;
      padding-top: 8px;
      font-weight: 600;
    }

    .category-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .rollup-secured { background: #3fb950; }
    .issuer-secured { background: #d29922; }
    .third-party-secured { background: #f85149; }

    .legend {
      margin-bottom: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      padding: 4px 0;
      font-size: 12px;
    }

    .node-info {
      background: #21262d;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
      display: none;
    }

    .node-info.visible {
      display: block;
    }

    .node-info h3 {
      font-size: 14px;
      color: #58a6ff;
      margin-bottom: 8px;
    }

    .node-info p {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 4px;
    }

    .node-info .value {
      color: #c9d1d9;
      font-weight: 500;
    }

    .trusted-party {
      background: #30363d;
      border-radius: 4px;
      padding: 8px;
      margin-top: 8px;
      font-size: 11px;
    }

    .trusted-party .name {
      color: #f0883e;
      font-weight: 600;
    }

    .trusted-party .role {
      color: #8b949e;
      font-size: 10px;
    }

    .trusted-party .powers {
      color: #c9d1d9;
      margin-top: 4px;
    }

    .trusted-party .risk {
      color: #f85149;
      font-style: italic;
      margin-top: 4px;
    }

    .filter-section {
      margin-bottom: 16px;
    }

    .filter-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .filter-btn:hover {
      background: #30363d;
    }

    .filter-btn.active {
      background: #388bfd;
      border-color: #388bfd;
    }

    /* Graph styles */
    .node {
      cursor: pointer;
    }

    .node circle {
      stroke: #30363d;
      stroke-width: 2px;
    }

    .node text {
      font-size: 10px;
      fill: #c9d1d9;
      pointer-events: none;
    }

    .node.escrow circle {
      stroke-width: 3px;
    }

    .node.trusted-party-node circle {
      stroke-dasharray: 3,3;
    }

    .link {
      stroke: #30363d;
      stroke-opacity: 0.6;
    }

    .link.control {
      stroke: #f0883e;
    }

    .link.validates {
      stroke: #a371f7;
      stroke-dasharray: 5,5;
    }

    .node.highlighted circle {
      stroke: #58a6ff;
      stroke-width: 4px;
    }

    .node.dimmed {
      opacity: 0.2;
    }

    .link.dimmed {
      opacity: 0.1;
    }

    #tooltip {
      position: absolute;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      max-width: 300px;
      z-index: 1000;
    }

    #tooltip.visible {
      opacity: 1;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
    }

    .control-btn {
      background: #21262d;
      border: 1px solid #30363d;
      color: #c9d1d9;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .control-btn:hover {
      background: #30363d;
    }

    #file-input {
      display: none;
    }

    .load-section {
      text-align: center;
      padding: 40px;
    }

    .load-btn {
      background: #238636;
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }

    .load-btn:hover {
      background: #2ea043;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="sidebar">
      <h1>Escrow Trust Model</h1>

      <div id="load-section" class="load-section">
        <p style="margin-bottom: 16px; color: #8b949e;">Load analysis JSON to visualize</p>
        <label for="file-input" class="load-btn">Load JSON File</label>
        <input type="file" id="file-input" accept=".json">
        <p style="margin-top: 16px; font-size: 11px; color: #8b949e;">
          Run: <code style="background: #21262d; padding: 2px 6px; border-radius: 3px;">node -r esbuild-register scripts/escrowAnalysis/analyzeEscrows.ts arbitrum</code>
        </p>
      </div>

      <div id="analysis-content" style="display: none;">
        <div class="summary-box">
          <div class="summary-row">
            <span><span class="category-dot rollup-secured"></span>Rollup-Secured</span>
            <span id="rollup-tvl">-</span>
          </div>
          <div class="summary-row">
            <span><span class="category-dot issuer-secured"></span>Issuer-Secured</span>
            <span id="issuer-tvl">-</span>
          </div>
          <div class="summary-row">
            <span><span class="category-dot third-party-secured"></span>Third-Party</span>
            <span id="third-party-tvl">-</span>
          </div>
          <div class="summary-row total">
            <span>Total TVL</span>
            <span id="total-tvl">-</span>
          </div>
        </div>

        <h2>Filter by Category</h2>
        <div class="filter-section">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="rollup-secured">Rollup</button>
          <button class="filter-btn" data-filter="issuer-secured">Issuer</button>
          <button class="filter-btn" data-filter="third-party-secured">Third-Party</button>
        </div>

        <h2>Legend</h2>
        <div class="legend">
          <div class="legend-item">
            <svg width="20" height="20"><circle cx="10" cy="10" r="8" fill="#3fb950"/></svg>
            <span style="margin-left: 8px;">Escrow / Token (Rollup-Secured)</span>
          </div>
          <div class="legend-item">
            <svg width="20" height="20"><circle cx="10" cy="10" r="8" fill="#d29922"/></svg>
            <span style="margin-left: 8px;">Escrow / Token (Issuer-Secured)</span>
          </div>
          <div class="legend-item">
            <svg width="20" height="20"><circle cx="10" cy="10" r="8" fill="#f85149"/></svg>
            <span style="margin-left: 8px;">Escrow / Token (Third-Party)</span>
          </div>
          <div class="legend-item">
            <svg width="20" height="20"><circle cx="10" cy="10" r="6" fill="#30363d" stroke="#f0883e" stroke-width="2"/></svg>
            <span style="margin-left: 8px;">Trusted Party</span>
          </div>
        </div>

        <h2>Selected Node</h2>
        <div id="node-info" class="node-info">
          <p style="color: #8b949e;">Click a node to see details</p>
        </div>
      </div>
    </div>

    <div id="graph">
      <div class="controls">
        <button class="control-btn" id="zoom-in">+</button>
        <button class="control-btn" id="zoom-out">-</button>
        <button class="control-btn" id="reset">Reset</button>
      </div>
      <div id="tooltip"></div>
    </div>
  </div>

  <script>
    // Global state
    let data = null;
    let simulation = null;
    let svg = null;
    let g = null;
    let zoom = null;
    let currentFilter = 'all';

    // Color scale
    const categoryColors = {
      'rollup-secured': '#3fb950',
      'issuer-secured': '#d29922',
      'third-party-secured': '#f85149'
    };

    // Format currency
    function formatUsd(value) {
      if (value >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
      if (value >= 1e3) return `$${(value / 1e3).toFixed(2)}K`;
      return `$${value.toFixed(2)}`;
    }

    // Load JSON file
    document.getElementById('file-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            data = JSON.parse(e.target.result);
            initVisualization();
          } catch (err) {
            alert('Error parsing JSON: ' + err.message);
          }
        };
        reader.readAsText(file);
      }
    });

    // Initialize visualization
    function initVisualization() {
      document.getElementById('load-section').style.display = 'none';
      document.getElementById('analysis-content').style.display = 'block';

      // Update summary
      document.getElementById('rollup-tvl').textContent = formatUsd(data.summary.rollupSecuredTvl);
      document.getElementById('issuer-tvl').textContent = formatUsd(data.summary.issuerSecuredTvl);
      document.getElementById('third-party-tvl').textContent = formatUsd(data.summary.thirdPartySecuredTvl);
      document.getElementById('total-tvl').textContent = formatUsd(data.summary.totalTvl);

      // Build graph data
      const graphData = buildGraphData(data);

      // Create visualization
      createGraph(graphData);

      // Setup filters
      setupFilters();
    }

    // Build graph data from analysis
    function buildGraphData(analysis) {
      const nodes = [];
      const links = [];
      const nodeMap = new Map();

      // Add escrow nodes
      analysis.escrows.forEach((escrow, i) => {
        const nodeId = `escrow-${i}`;
        const node = {
          id: nodeId,
          type: 'escrow',
          name: escrow.name,
          category: escrow.category,
          value: escrow.totalValueUsd,
          data: escrow,
          radius: Math.max(15, Math.min(50, Math.sqrt(escrow.totalValueUsd / 1e7)))
        };
        nodes.push(node);
        nodeMap.set(nodeId, node);

        // Add trusted parties for this escrow
        if (escrow.trustedParties) {
          escrow.trustedParties.forEach((party, j) => {
            const partyId = `party-${party.name.replace(/\s+/g, '-')}`;

            if (!nodeMap.has(partyId)) {
              const partyNode = {
                id: partyId,
                type: 'trusted-party',
                name: party.name,
                category: null,
                data: party,
                radius: 12
              };
              nodes.push(partyNode);
              nodeMap.set(partyId, partyNode);
            }

            links.push({
              source: partyId,
              target: nodeId,
              type: party.role.includes('Validator') ? 'validates' : 'control'
            });
          });
        }
      });

      // Add external token nodes
      analysis.externalTokens.forEach((token, i) => {
        const nodeId = `token-${i}`;
        const node = {
          id: nodeId,
          type: 'token',
          name: `${token.symbol} (${token.bridgeProtocol})`,
          category: token.category,
          value: token.valueUsd,
          data: token,
          radius: Math.max(10, Math.min(40, Math.sqrt(token.valueUsd / 1e7)))
        };
        nodes.push(node);
        nodeMap.set(nodeId, node);

        // Add trusted parties
        if (token.trustedParties) {
          token.trustedParties.forEach((party) => {
            const partyId = `party-${party.name.replace(/\s+/g, '-')}`;

            if (!nodeMap.has(partyId)) {
              const partyNode = {
                id: partyId,
                type: 'trusted-party',
                name: party.name,
                category: null,
                data: party,
                radius: 12
              };
              nodes.push(partyNode);
              nodeMap.set(partyId, partyNode);
            }

            links.push({
              source: partyId,
              target: nodeId,
              type: party.role.includes('Validator') ? 'validates' : 'control'
            });
          });
        }
      });

      return { nodes, links };
    }

    // Create D3 force graph
    function createGraph(graphData) {
      const container = document.getElementById('graph');
      const width = container.clientWidth;
      const height = container.clientHeight;

      // Clear existing
      d3.select('#graph svg').remove();

      // Create SVG
      svg = d3.select('#graph')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // Create zoom behavior
      zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom);

      // Create container group
      g = svg.append('g');

      // Create arrow markers
      svg.append('defs').selectAll('marker')
        .data(['control', 'validates'])
        .enter().append('marker')
        .attr('id', d => `arrow-${d}`)
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 20)
        .attr('refY', 0)
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .attr('orient', 'auto')
        .append('path')
        .attr('fill', d => d === 'control' ? '#f0883e' : '#a371f7')
        .attr('d', 'M0,-5L10,0L0,5');

      // Create simulation
      simulation = d3.forceSimulation(graphData.nodes)
        .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(d => d.radius + 10));

      // Create links
      const link = g.append('g')
        .selectAll('line')
        .data(graphData.links)
        .enter().append('line')
        .attr('class', d => `link ${d.type}`)
        .attr('marker-end', d => `url(#arrow-${d.type})`);

      // Create nodes
      const node = g.append('g')
        .selectAll('g')
        .data(graphData.nodes)
        .enter().append('g')
        .attr('class', d => `node ${d.type === 'trusted-party' ? 'trusted-party-node' : d.type}`)
        .attr('data-category', d => d.category)
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      // Add circles
      node.append('circle')
        .attr('r', d => d.radius)
        .attr('fill', d => {
          if (d.type === 'trusted-party') return '#30363d';
          return categoryColors[d.category] || '#8b949e';
        })
        .attr('stroke', d => d.type === 'trusted-party' ? '#f0883e' : null);

      // Add labels
      node.append('text')
        .attr('dy', d => d.radius + 12)
        .attr('text-anchor', 'middle')
        .text(d => d.name.length > 20 ? d.name.substring(0, 20) + '...' : d.name);

      // Add value labels for escrows/tokens
      node.filter(d => d.type !== 'trusted-party')
        .append('text')
        .attr('dy', 4)
        .attr('text-anchor', 'middle')
        .attr('font-size', '9px')
        .attr('fill', '#fff')
        .text(d => formatUsd(d.value));

      // Tooltip and click handlers
      const tooltip = d3.select('#tooltip');

      node.on('mouseover', function(event, d) {
        tooltip
          .style('left', (event.pageX + 10) + 'px')
          .style('top', (event.pageY - 10) + 'px')
          .classed('visible', true);

        if (d.type === 'trusted-party') {
          tooltip.html(`
            <strong style="color: #f0883e;">${d.name}</strong><br>
            <span style="color: #8b949e;">${d.data.role}</span><br>
            <span style="color: #f85149; font-size: 11px;">${d.data.riskDescription}</span>
          `);
        } else {
          tooltip.html(`
            <strong style="color: #58a6ff;">${d.name}</strong><br>
            <span style="color: #8b949e;">TVL: ${formatUsd(d.value)}</span><br>
            <span style="color: ${categoryColors[d.category]};">${d.category}</span>
          `);
        }

        // Highlight connected nodes
        highlightConnected(d, graphData);
      });

      node.on('mouseout', function() {
        tooltip.classed('visible', false);
        resetHighlight();
      });

      node.on('click', function(event, d) {
        showNodeInfo(d);
      });

      // Update positions on tick
      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      // Store for filtering
      window.graphElements = { node, link, graphData };
    }

    // Drag functions
    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    // Highlight connected nodes
    function highlightConnected(d, graphData) {
      const connectedIds = new Set([d.id]);

      graphData.links.forEach(link => {
        if (link.source.id === d.id) connectedIds.add(link.target.id);
        if (link.target.id === d.id) connectedIds.add(link.source.id);
      });

      d3.selectAll('.node').classed('dimmed', n => !connectedIds.has(n.id));
      d3.selectAll('.link').classed('dimmed', l =>
        !connectedIds.has(l.source.id) || !connectedIds.has(l.target.id)
      );
    }

    function resetHighlight() {
      d3.selectAll('.node').classed('dimmed', false);
      d3.selectAll('.link').classed('dimmed', false);
    }

    // Show node info in sidebar
    function showNodeInfo(d) {
      const infoDiv = document.getElementById('node-info');
      infoDiv.classList.add('visible');

      if (d.type === 'trusted-party') {
        infoDiv.innerHTML = `
          <h3>${d.name}</h3>
          <p>Role: <span class="value">${d.data.role}</span></p>
          <p>Powers:</p>
          <ul style="margin-left: 16px; font-size: 12px;">
            ${d.data.powers.map(p => `<li>${p}</li>`).join('')}
          </ul>
          <p style="color: #f85149; margin-top: 8px;">Risk: ${d.data.riskDescription}</p>
        `;
      } else {
        const escrowData = d.data;
        let html = `
          <h3>${d.name}</h3>
          <p>TVL: <span class="value">${formatUsd(d.value)}</span></p>
          <p>Category: <span class="value" style="color: ${categoryColors[d.category]}">${d.category}</span></p>
          <p style="font-size: 11px; color: #8b949e; margin-top: 8px;">${escrowData.categoryReason || ''}</p>
        `;

        if (escrowData.trustedParties && escrowData.trustedParties.length > 0) {
          html += `<h4 style="margin-top: 12px; font-size: 12px; color: #f0883e;">Trusted Parties (${escrowData.trustedParties.length})</h4>`;
          escrowData.trustedParties.forEach(party => {
            html += `
              <div class="trusted-party">
                <div class="name">${party.name}</div>
                <div class="role">${party.role}</div>
                <div class="powers">Powers: ${party.powers.join(', ')}</div>
                <div class="risk">Risk: ${party.riskDescription}</div>
              </div>
            `;
          });
        }

        infoDiv.innerHTML = html;
      }
    }

    // Setup filters
    function setupFilters() {
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          const filter = this.dataset.filter;
          applyFilter(filter);
        });
      });
    }

    function applyFilter(filter) {
      currentFilter = filter;

      if (!window.graphElements) return;

      const { node, link, graphData } = window.graphElements;

      if (filter === 'all') {
        node.style('display', 'block');
        link.style('display', 'block');
      } else {
        // Show only nodes matching filter and their connected trusted parties
        const visibleNodeIds = new Set();

        graphData.nodes.forEach(n => {
          if (n.category === filter) {
            visibleNodeIds.add(n.id);
          }
        });

        // Add connected trusted parties
        graphData.links.forEach(l => {
          if (visibleNodeIds.has(l.target.id) || visibleNodeIds.has(l.target)) {
            const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
            visibleNodeIds.add(sourceId);
          }
        });

        node.style('display', n => visibleNodeIds.has(n.id) ? 'block' : 'none');
        link.style('display', l => {
          const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
          const targetId = typeof l.target === 'object' ? l.target.id : l.target;
          return visibleNodeIds.has(sourceId) && visibleNodeIds.has(targetId) ? 'block' : 'none';
        });
      }
    }

    // Zoom controls
    document.getElementById('zoom-in').addEventListener('click', () => {
      svg.transition().call(zoom.scaleBy, 1.3);
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
      svg.transition().call(zoom.scaleBy, 0.7);
    });

    document.getElementById('reset').addEventListener('click', () => {
      svg.transition().call(zoom.transform, d3.zoomIdentity);
    });

    // Handle resize
    window.addEventListener('resize', () => {
      if (data) {
        const graphData = buildGraphData(data);
        createGraph(graphData);
        applyFilter(currentFilter);
      }
    });
  </script>
</body>
</html>
