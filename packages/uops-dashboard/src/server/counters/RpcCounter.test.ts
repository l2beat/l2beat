import type { EVMTransaction } from '@l2beat/shared'
import {
  EIP_7821_TRANSACTION_SELECTOR,
  EIP712_methods,
  EIP712_TX_TYPE,
  EIP7821_methods,
  ENTRY_POINT_ADDRESS_0_6_0,
  ENTRY_POINT_ADDRESS_0_7_0,
  ERC20ROUTER_methods,
  ERC20ROUTER_TRANSACTION_SELECTOR,
  ERC4337_methods,
  MULTICALL_V3,
  MULTICALLV3_methods,
  SAFE_MULTI_SEND_CALL_ONLY_1_3_0,
  SAFE_methods,
} from '@l2beat/shared/uops'
import { type Block, EthereumAddress, UnixTime } from '@l2beat/shared-pure'
import { expect, mockFn, mockObject } from 'earl'
import type {
  CountedBlock,
  CountedOperation,
  CountedTransaction,
} from '@/types'
import { RpcCounter } from './RpcCounter'

describe(RpcCounter.name, () => {
  describe(RpcCounter.prototype.countForBlock.name, () => {
    it('should return block with counted operations', () => {
      const mockBlock: Block = createBlock(1)

      const expectedResult: CountedBlock = {
        ...mockBlock,
        status: '<unknown>',
        transactions: [
          {
            hash: 'tx1.hash',
            operationsCount: 1,
            type: 'ERC-4337 Entry Point 0.6.0',
            from: 'tx1.from',
          },
          {
            hash: 'tx2.hash',
            operationsCount: 2,
            type: 'ERC-4337 Entry Point 0.6.0',
            from: 'tx1.from',
          },
        ],
      }

      const counter = new RpcCounter()

      counter.mapTransaction = mockFn()
        .returnsOnce(expectedResult.transactions[0])
        .returnsOnce(expectedResult.transactions[1])

      const result = counter.countForBlock(mockBlock)
      expect(result).toEqual(expectedResult)
    })
  })

  describe(RpcCounter.prototype.countForBlocks.name, () => {
    it('should return correct stats', () => {
      const end = UnixTime.now()
      const start = end - 1 * UnixTime.HOUR

      const mockBlocks: Block[] = [
        createBlock(1, start),
        createBlock(2),
        createBlock(3, end),
      ]

      const counter = new RpcCounter()

      const mockSmartAccountUsageForBlock1 = new Map([
        ['execute(address,uint256,bytes)', 2],
      ])

      const mockSmartAccountUsageForBlock2 = new Map([
        ['execute(address,uint256,bytes)', 1],
        ['executeBatch(address[],bytes[])', 1],
      ])

      const mockSmartAccountUsageForBlock3 = new Map([
        ['execute(address,uint256,bytes)', 1],
        ['unknown', 1],
      ])

      counter.generateSmartAccountUsageForBlock = mockFn()
        .returnsOnce(mockSmartAccountUsageForBlock1)
        .returnsOnce(mockSmartAccountUsageForBlock2)
        .returnsOnce(mockSmartAccountUsageForBlock3)

      counter.mapTransaction = mockFn()
        .returnsOnce(createCountedTransaction(2, false))
        .returnsOnce(createCountedTransaction(1, false))
        .returnsOnce(createCountedTransaction(3, true))
        .returnsOnce(createCountedTransaction(3, false))
        .returnsOnce(createCountedTransaction(1, true))
        .returnsOnce(createCountedTransaction(1, false))

      const result = counter.countForBlocks(mockBlocks)
      expect(result).toEqual({
        dateStart: UnixTime.toDate(start),
        dateEnd: UnixTime.toDate(end),
        numberOfTransactions: 6,
        numberOfOperations: 11,
        topBlocks: [
          {
            number: 3,
            ratio: 1,
            includesBatch: true,
            includesUnknown: true,
          },
          {
            number: 2,
            ratio: 3,
            includesBatch: true,
            includesUnknown: false,
          },
          {
            number: 1,
            ratio: 1.5,
            includesBatch: false,
            includesUnknown: false,
          },
        ],
        smartAccountUsage: [
          { signature: 'execute(address,uint256,bytes)', count: 4 },
          { signature: 'executeBatch(address[],bytes[])', count: 1 },
          { signature: 'unknown', count: 1 },
        ],
      })
    })
  })

  describe(RpcCounter.prototype.mapTransaction.name, () => {
    it('should return unknown for unrecognized txs', () => {
      const counter = new RpcCounter()

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: 'tx.to',
        hash: 'tx.hash',
        data: 'tx.data',
        type: '0',
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'Legacy',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
      })
    })

    it('should map ERC-4337 txs', () => {
      const counter = new RpcCounter()

      const mockOperation = {
        id: 'id',
        level: 0,
        methodSelector: '0x123',
        count: 1,
        children: [],
      } as CountedOperation

      counter.countUserOperations = mockFn().returns(mockOperation)

      counter.checkOperations = mockFn().returns({
        includesBatch: false,
        includesUnknown: false,
      })

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: ENTRY_POINT_ADDRESS_0_6_0,
        hash: 'tx.hash',
        data: 'tx.data',
        type: '2',
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'ERC-4337 Entry Point 0.6.0',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
        includesUnknown: false,
        details: mockOperation,
      })
    })

    it('should map GnosisSafe txs', () => {
      const counter = new RpcCounter()

      const mockOperation = {
        id: 'id',
        level: 0,
        methodSelector: '0x123',
        count: 1,
        children: [],
      } as CountedOperation

      counter.countUserOperations = mockFn().returns(mockOperation)

      counter.checkOperations = mockFn().returns({
        includesBatch: false,
        includesUnknown: false,
      })

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: SAFE_MULTI_SEND_CALL_ONLY_1_3_0,
        hash: 'tx.hash',
        data: 'tx.data',
        type: '2',
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'Safe: Multi Send Call Only 1.3.0',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
        includesUnknown: false,
        details: mockOperation,
      })
    })

    it('should map EIP-712 txs', () => {
      const counter = new RpcCounter()

      const mockOperation = {
        id: 'id',
        level: 0,
        methodSelector: '0x123',
        count: 1,
        children: [],
      } as CountedOperation

      counter.countUserOperations = mockFn().returns(mockOperation)

      counter.checkOperations = mockFn().returns({
        includesBatch: false,
        includesUnknown: false,
      })

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: 'tx.to',
        hash: 'tx.hash',
        data: 'tx.data',
        type: EIP712_TX_TYPE,
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'EIP-712',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
        includesUnknown: false,
        details: mockOperation,
      })
    })

    it('should map Multicall v3 txs', () => {
      const counter = new RpcCounter()

      const mockOperation = {
        id: 'id',
        level: 0,
        methodSelector: '0x123',
        count: 1,
        children: [],
      } as CountedOperation

      counter.countUserOperations = mockFn().returns(mockOperation)

      counter.checkOperations = mockFn().returns({
        includesBatch: false,
        includesUnknown: false,
      })

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: MULTICALL_V3,
        hash: 'tx.hash',
        data: 'tx.data',
        type: '2',
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'Multicall v3',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
        includesUnknown: false,
        details: mockOperation,
      })
    })

    it('should map ERC20Router txs', () => {
      const counter = new RpcCounter()

      const mockOperation = {
        id: 'id',
        level: 0,
        methodSelector: ERC20ROUTER_TRANSACTION_SELECTOR,
        count: 1,
        children: [],
      } as CountedOperation

      counter.countUserOperations = mockFn().returns(mockOperation)

      counter.checkOperations = mockFn().returns({
        includesBatch: false,
        includesUnknown: false,
      })

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: '0x1234',
        hash: 'tx.hash',
        data: `${ERC20ROUTER_TRANSACTION_SELECTOR}tx.data`,
        type: '2',
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'ERC-20 Router',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
        includesUnknown: false,
        details: mockOperation,
      })
    })

    it('should map EIP-7821 txs', () => {
      const counter = new RpcCounter()

      const mockOperation = {
        id: 'id',
        level: 0,
        methodSelector: '0x123',
        count: 1,
        children: [],
      } as CountedOperation

      counter.countUserOperations = mockFn().returns(mockOperation)

      counter.checkOperations = mockFn().returns({
        includesBatch: false,
        includesUnknown: false,
      })

      const result = counter.mapTransaction({
        from: 'tx.from',
        to: 'tx.to',
        hash: 'tx.hash',
        data: EIP_7821_TRANSACTION_SELECTOR + '12345',
        type: '2',
      })

      expect(result).toEqual({
        from: 'tx.from',
        type: 'EIP-7821',
        hash: 'tx.hash',
        operationsCount: 1,
        includesBatch: false,
        includesUnknown: false,
        details: mockOperation,
      })
    })
  })

  describe(RpcCounter.prototype.countUserOperations.name, () => {
    it('should count ERC-4337 user operations', () => {
      const calldata =
        '0x1fad948c000000000000000000000000000000000000000000000000000000000000004000000000000000000000000065061d355ae0359ec801e047e40c76051833e78c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000066000000000000000000000000005f123aaf77f2f128c26d026ba9725ce7f6c74fe0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000024e1000000000000000000000000000000000000000000000000000000000000115520000000000000000000000000000000000000000000000000000000000014b450000000000000000000000000000000000000000000000000000000000e6d2240000000000000000000000000000000000000000000000000000000000142440000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000344b61d27f60000000000000000000000009978c826d93883701522d2ca645d5436e56542520000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002a4243a71340000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002b06177b9ccea343be4f0f6ae0b5cc7fed681fdc000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041a32c378a1a8f266665ad7b551a58251763ca77d16b8fd3683c4904cee876b3fc7910f808fb9423237c2a70a9a66854e4b24299f63fbf8264a02c235852c914991b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000194c696e6b20796f75722065787465726e616c2077616c6c657400000000000000000000000000000000000000f4629b4128efb49b8548765df26b02d74571259d000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000004104c29cde93788ba82029674026b4742251e0fa1fd6d8f03dd93e1b3fe184d3104b20f2d140f938d665fd4b7f55f9c64f5a9b48e5da2fce769a7ce51da3ce10521c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000194c696e6b20796f75722065787465726e616c2077616c6c657400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000754fd9098af9ddcb41da48a1d78f91f1398965addc000000000000000067174d1400000000000000000000000000000000000000007d18a21979f3521e81632e428bf49754a75c5b0de8e6b1679139c10dac66d771018232f04dc96ff141cd1788038da6246f5c1ee8fbcb6933875ed8db52f5df021b00000000000000000000000000000000000000000000000000000000000000000000000000000000000041bafa7be880f56b53bb842cdd4cd38940fd698e939a2df2950ba1203bc48ca4da5fc951702196272b899424defe6cd1ad6288e1f910477f6e0cf38b7a3fd053781c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000713030a35fc8caf90ad1f0982629610b7d9d0da50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000002c143000000000000000000000000000000000000000000000000000000000006c52c00000000000000000000000000000000000000000000000000000000000137d40000000000000000000000000000000000000000000000000000000000e6d2240000000000000000000000000000000000000000000000000000000000142440000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000000589406cc6185a346906296840746125a0e449764545fbfb9cf00000000000000000000000024272187a424d084b5e086f7e2f6f935f216ad06000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000204b61d27f60000000000000000000000009978c826d93883701522d2ca645d5436e56542520000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001642f4614530000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024272187a424d084b5e086f7e2f6f935f216ad06000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041699bd04ff2656283df89442ff4a5f38db0c9a8959a0ad788d9d7bc1319966ffc50d4d5eae58c4e3e2c1dd3eb8216eccd58a8d85fa6be2462e02fb2bc4425c3701c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000194c696e6b20796f75722065787465726e616c2077616c6c657400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000754fd9098af9ddcb41da48a1d78f91f1398965addc000000000000000067174d150000000000000000000000000000000000000000016356d2d7da8d4179da8fc82ddb5cdcf089079afa0950da7e201c39affbff6b697974599ceffc0b3ea5b07140b97606063263f48648606e0d405539bffe220a1b0000000000000000000000000000000000000000000000000000000000000000000000000000000000004151028a9a6ccf83b3a013cdde031532c58d186d4737344fbc4ad54bde759c210707c561fb8938809ad529fb66ce6e13d01808ddd945f6ec710d78782692faaacf1b00000000000000000000000000000000000000000000000000000000000000'

      const expectedResult: CountedOperation = {
        children: [
          {
            children: [
              {
                children: [],
                contractAddress: '0x9978c826d93883701522d2CA645d5436e5654252',
                count: 1,
                id: 'id',
                level: 2,
                methodSelector: '0x243a7134',
              },
            ],
            contractAddress: '0x05f123AaF77F2F128C26D026Ba9725cE7f6c74fE',
            contractName: 'SmartAccount',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'execute',
            methodSelector: '0xb61d27f6',
            methodSignature: 'execute(address,uint256,bytes)',
          },
          {
            children: [],
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'contract_deployment',
            methodSelector: '',
          },
          {
            children: [
              {
                children: [],
                contractAddress: '0x9978c826d93883701522d2CA645d5436e5654252',
                count: 1,
                id: 'id',
                level: 2,
                methodSelector: '0x2f461453',
              },
            ],
            contractAddress: '0x713030a35FC8cAf90ad1F0982629610B7D9D0da5',
            contractName: 'SmartAccount',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'execute',
            methodSelector: '0xb61d27f6',
            methodSignature: 'execute(address,uint256,bytes)',
          },
        ],
        contractAddress: '0x5ff137d4b0fdcd49dca30c7cf57e578a026d2789',
        contractName: 'ERC-4337:EntryPoint0.6.0',
        count: 3,
        id: 'id',
        level: 0,
        methodName: 'handleOps',
        methodSelector: '0x1fad948c',
        methodSignature:
          'handleOps((address,uint256,bytes,bytes,uint256,uint256,uint256,uint256,uint256,bytes,bytes)[],address)',
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        ENTRY_POINT_ADDRESS_0_6_0,
        ERC4337_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should count GnosisSafe user operations', () => {
      const calldata =
        '0x8d80ff0a00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000b0400feef177e6168f9b7fd59e6c5b6c2d87ff398c6fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002246a7612020000000000000000000000007d7c1f5b9a4cbf87d8163bf6be7cc7d661c0f8b500000000000000000000000000000000000000000000000154bd8a0a38bc90000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082f73b5ee4cac89faecb44cfb228532b0085fe0ab12ec2b2261467c3ee1af5d3dc0febd7f984e6d77df1a9edb318416eddac9f2ff09f89e7ec1f71d11666bed40c1bc5726017e5bceff5e9152553a873a1db65c5ec3ae7041f659a491b6ec82ac0b5616ff52463ee69a7202a3cd1c433f293f97ca4935df2bf212436d9d462718e741f00000000000000000000000000000000000000000000000000000000000000feef177e6168f9b7fd59e6c5b6c2d87ff398c6fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002846a7612020000000000000000000000009d65ff81a3c488d585bbfb0bfe3c7707c7917f540000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007d7c1f5b9a4cbf87d8163bf6be7cc7d661c0f8b500000000000000000000000000000000000000000000001adeb80302ffd3e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008238f953fc670a56f8bf686b41fc7b8d3c0443ee63e455e9da0ec144e3cb50d5a64c3ca7f9fa34e48f5e0cdd7210c0bcaaa9644547c6664c1f1dad862b140314891b6d2563f888e2623fd484fd6b88ad96649a71f5b02b8ca8a99d7c3dd6565ddf2a72b7a81b69b6afbee10058f73adc04424f87459760702ad904acee6b549985d91c00000000000000000000000000000000000000000000000000000000000000feef177e6168f9b7fd59e6c5b6c2d87ff398c6fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002846a761202000000000000000000000000ec53bf9167f50cdeb3ae105f56099aaab9061f830000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007d7c1f5b9a4cbf87d8163bf6be7cc7d661c0f8b50000000000000000000000000000000000000000000002b8e45fe63984e3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008212b2bafc025de0c768b5723398964e92f2a28a71bdd76791503b8a610638e1ad461ff71c669afbe29038074e5a6390d470fb92ea5a4992275ea11ccd1dd765af1ca343555eee4e04b5aff358be5e95d15b5115e442eafd16f6afb8c9073585463a381ca544963132d7c356c497ad2767e4c8cc3fa1438ea7246e6b4ef0cfc7f7a71c00000000000000000000000000000000000000000000000000000000000000feef177e6168f9b7fd59e6c5b6c2d87ff398c6fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002846a7612020000000000000000000000004d1c297d39c5c1277964d0e3f8aa9014936645300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000044a9059cbb0000000000000000000000007d7c1f5b9a4cbf87d8163bf6be7cc7d661c0f8b500000000000000000000000000000000000000000000316ec0e8772bac1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000082730f3dbed92a15d268de3d67b58833861ca921ef334d6b86a931e781aa3b474f272d6384f9e1f7be00163b07b345d1310e6fb1c0b620a77e324382d37bf504241bef32029e336da6c480b963edd0734b1dc259d84740c2b64a73a9d0e04657b79506b9c9d603cd9cb90161d459be81966e447e37cb5c680ae3e6fea8e0a8c655a91c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'

      const expectedResult: CountedOperation = {
        children: [
          {
            children: [
              {
                children: [],
                contractAddress: '0x7d7C1F5B9A4cbf87D8163bf6Be7cC7D661C0f8B5',
                count: 1,
                id: 'id',
                level: 2,
                methodSelector: '0x',
              },
            ],
            contractAddress: '0xfeef177E6168F9b7fd59e6C5b6c2d87FF398c6FD',
            contractName: 'Safe:Singleton1.3.0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'execTransaction',
            methodSelector: '0x6a761202',
            methodSignature:
              'execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)',
          },
          {
            children: [
              {
                children: [],
                contractAddress: '0x9D65fF81a3c488d585bBfb0Bfe3c7707c7917f54',
                count: 1,
                id: 'id',
                level: 2,
                methodSelector: '0xa9059cbb',
              },
            ],
            contractAddress: '0xfeef177E6168F9b7fd59e6C5b6c2d87FF398c6FD',
            contractName: 'Safe:Singleton1.3.0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'execTransaction',
            methodSelector: '0x6a761202',
            methodSignature:
              'execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)',
          },
          {
            children: [
              {
                children: [],
                contractAddress: '0xec53bF9167f50cDEB3Ae105f56099aaaB9061F83',
                count: 1,
                id: 'id',
                level: 2,
                methodSelector: '0xa9059cbb',
              },
            ],
            contractAddress: '0xfeef177E6168F9b7fd59e6C5b6c2d87FF398c6FD',
            contractName: 'Safe:Singleton1.3.0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'execTransaction',
            methodSelector: '0x6a761202',
            methodSignature:
              'execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)',
          },
          {
            children: [
              {
                children: [],
                contractAddress: '0x4d1C297d39C5c1277964D0E3f8Aa901493664530',
                count: 1,
                id: 'id',
                level: 2,
                methodSelector: '0xa9059cbb',
              },
            ],
            contractAddress: '0xfeef177E6168F9b7fd59e6C5b6c2d87FF398c6FD',
            contractName: 'Safe:Singleton1.3.0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'execTransaction',
            methodSelector: '0x6a761202',
            methodSignature:
              'execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)',
          },
        ],
        contractAddress: '0x40a2accbd92bca938b02010e17a5b8929b49130d',
        contractName: 'Safe:MultiSendCallOnly1.3.0',
        count: 4,
        id: 'id',
        level: 0,
        methodName: 'multiSend',
        methodSelector: '0x8d80ff0a',
        methodSignature: 'multiSend(bytes)',
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        SAFE_MULTI_SEND_CALL_ONLY_1_3_0,
        SAFE_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should count EIP-712 user operations', () => {
      const calldata =
        '0x8f0273a900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001200000000000000000000000009248f1ee8cbd029f3d22a92eb270333a39846fb200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000242e1a7d4d00000000000000000000000000000000000000000000003635c9adc5dea00000000000000000000000000000000000000000000000000000000000000000000000000000000000009248f1ee8cbd029f3d22a92eb270333a39846fb200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000043d18b91200000000000000000000000000000000000000000000000000000000'

      const expectedResult: CountedOperation = {
        contractAddress: 'tx.to',
        contractName: 'ClaveSmartWallet',
        count: 2,
        id: 'id',
        level: 0,
        methodName: 'batchCall',
        methodSelector: '0x8f0273a9',
        methodSignature: 'batchCall((address,bool,uint256,bytes)[])',
        children: [
          {
            children: [],
            contractAddress: '0x9248F1Ee8cBD029F3D22A92EB270333a39846fB2',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x2e1a7d4d',
          },
          {
            children: [],
            contractAddress: '0x9248F1Ee8cBD029F3D22A92EB270333a39846fB2',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x3d18b912',
          },
        ],
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        'tx.to',
        EIP712_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should count Multicall v3 user operations', () => {
      const calldata =
        '0x82ad56cb0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000005c000000000000000000000000002238bb0085395ae52cd4755456891fc2fd5934d000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000164000000000000000000000000000000000000000000000000000000000075abd795d5418a00000000000000000000000000000000000000000000000000000000673f247b00000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000001bde3868dd9a2ab4288f72284b1a7420d6390db93b5ccec47035c71fe2a98d556c36c863df0c9100b6268a90312c5c1a6a5c4ef1afcbfcf94abbda594818982909743ccd28307a009623a59bd7aff6de4746256859260d30c054fef4fb300f6f3c000000000000000000000000ab2cbae4c5a66eb7c115392e4d15e2cfc877b9e70000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000d1d4b60718a8f91a5a8d7dae6fa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b5130cc30be369afeac34b61d60ddfdef84b7b6300000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000010400000082000000000000000000000000000000000000000000000001a611f1666fe84c6300000000000000000000000000000000000000000000000000000000673f247b000000000000000000000000000000000000000000000000000000000000006018358f517cc6527eabfbaafcdc5ff57de7dbd683cf17a8de7f22900d8db2987300000000000000000000000043349fb50ec2494e285810f3fed2d042015a8f210000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000d1d4b6071778f9195a5a8d7dafb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a770582353b573cbfdcc948751750eeb3ccf23cf000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104000000820000000000000000000000000000000000000000000000d000db0ce74f1fcf8700000000000000000000000000000000000000000000000000000000673f24af000000000000000000000000000000000000000000000000000000000000006035c86360b9308d16cd50b77c72bf76997a9bf33f671fbc4e692b1bfe96aef7f1000000000000000000000000077495fbdd645b3d667d198fc85f97905c61a4720000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000d161d608a8fa5a8acd9dae6fafb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000046ef0071b1e2ff6b42d36e5a177ea43ae5917f4e000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104000000820000000000000000000000000000000000000000000000af8347ea3f83b4000000000000000000000000000000000000000000000000000000000000673f24af0000000000000000000000000000000000000000000000000000000000000060ea078420052ad4433702241a49911a47a9789f6583865544114e0f9b32322427000000000000000000000000cc0c20e3cbcced39dfcad858f68b5330b476f9980000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000d6071778a8f91a8acd7d9dae6fb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'

      const expectedResult: CountedOperation = {
        contractAddress: 'tx.to',
        contractName: 'Multicall3',
        count: 4,
        id: 'id',
        level: 0,
        methodName: 'aggregate3',
        methodSelector: '0x82ad56cb',
        methodSignature: 'aggregate3((address,bool,bytes)[])',
        children: [
          {
            children: [],
            contractAddress: '0x02238BB0085395ae52cd4755456891Fc2fd5934D',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x00000000',
          },
          {
            children: [],
            contractAddress: '0xb5130cC30Be369AFEaC34B61D60dDFDef84B7B63',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x00000082',
          },
          {
            children: [],
            contractAddress: '0xA770582353b573CbfdCC948751750EeB3Ccf23CF',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x00000082',
          },
          {
            children: [],
            contractAddress: '0x46ef0071b1E2fF6B42d36e5A177EA43Ae5917f4E',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x00000082',
          },
        ],
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        'tx.to',
        MULTICALLV3_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should count ERC20Router user operations', () => {
      const calldata =
        '0x6e305f8000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000f70da97812cb96acdf810712aa562db8dfa3dbef0000000000000000000000007712fa47387542819d4e35a23f8116c90c18767c0000000000000000000000007df4e182da01eba2ff902b3f13b7a7b12bb87dea0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a45ae401dc00000000000000000000000000000000000000000000000000000000679b32bd00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e404e45aaf0000000000000000000000003439153eb7af838ad19d56e1571fbd09333c280900000000000000000000000084a71ccd554cc1b02749b35d22f684cc8ec987e100000000000000000000000000000000000000000000000000000000000001f40000000000000000000000007df4e182da01eba2ff902b3f13b7a7b12bb87dea000000000000000000000000000000000000000000000000000039c46ad842dc00000000000000000000000000000000000000000000000000000000000311220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000443dad0c9c00000000000000000000000084a71ccd554cc1b02749b35d22f684cc8ec987e10000000000000000000000008f0e83b5d39cd05d85ced3a0ca71ad3234fc3c2d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000ec9d5b864000000000000000000000000000000000000000000000000000039c46ad842dc0000000000000000000000000000000000000000000000000000000000000000a2ed48d5e4110f80e54a743f15664e7372614a11da71fd0a24b8316b49aea915'

      const expectedResult: CountedOperation = {
        children: [
          {
            children: [],
            contractAddress: EthereumAddress(
              '0xf70da97812CB96acDF810712Aa562db8dfA3dbEF',
            ),
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x',
          },
          {
            children: [],
            contractAddress: EthereumAddress(
              '0x7712FA47387542819d4E35A23f8116C90C18767C',
            ),
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x5ae401dc',
          },
          {
            children: [],
            contractAddress: EthereumAddress(
              '0x7dF4E182Da01EbA2FF902b3F13b7a7b12bB87dEa',
            ),
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x3dad0c9c',
          },
        ],
        contractAddress: 'tx.to',
        contractName: 'ERC20Router',
        count: 3,
        id: 'id',
        level: 0,
        methodName: 'delegatecallMulticall',
        methodSelector: '0x6e305f80',
        methodSignature:
          'delegatecallMulticall(address[],bytes[],uint256[],address)',
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        'tx.to',
        ERC20ROUTER_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should count EIP-7821 user operations', () => {
      const calldata =
        '0xe9ae5c530100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000006600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000026000000000000000000000000027a09b5de426a6f3ce12251c43dae670bad95a2e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044095ea7b3000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba3ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022d473030f116ddee9f6b43ac78ba300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000008487517c4500000000000000000000000027a09b5de426a6f3ce12251c43dae670bad95a2e00000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af000000000000000000000000ffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006853eaab0000000000000000000000000000000000000000000000000000000000000000000000000000000066a9893cc07d91d95644aedd05d03f95e1dba8af0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000003253593564c000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000682c64b7000000000000000000000000000000000000000000000000000000000000000308060c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000011f0183c103440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000027a09b5de426a6f3ce12251c43dae670bad95a2e000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000060000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c000000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000000400000000000000000000000001897109ae285beafab575dd63b5ba6bd2ec4cf6300000000000000000000000000000000000000000000000001c5dedd85bd2c7b0c000000000000000000000000000000000000000000000000000000'

      const expectedResult: CountedOperation = {
        children: [
          {
            children: [],
            contractAddress: '0x27A09B5DE426A6f3cE12251c43DaE670BAD95a2e',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x095ea7b3',
          },
          {
            children: [],
            contractAddress: '0x000000000022D473030F116dDEE9F6B43aC78BA3',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x87517c45',
          },
          {
            children: [],
            contractAddress: '0x66a9893cC07D91D95644AEDD05D03f95e1dBA8Af',
            count: 1,
            id: 'id',
            level: 1,
            methodSelector: '0x3593564c',
          },
        ],
        contractAddress: 'to',
        contractName: 'EIP-7821',
        count: 3,
        id: 'id',
        level: 0,
        methodName: 'execute',
        methodSelector: '0xe9ae5c53',
        methodSignature: 'execute(bytes32,bytes)',
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        'to',
        EIP7821_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should count WhiteBIT user operations', () => {
      const calldata =
        '0xaf71356622033527012829ff2a2b012c2d002e2f013031013233012634003e44014342004140003f3d00363c013b3a00393800372400251c012310000f0e000d02000c02000902000a0800070601050400110b00131200222100201f001e1d011b14001a19001817161545a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000059682f006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000000000007d2b7500b55a6a5e1b1321538e4e7a5c8d01a757fb86605900000000000000000000000000000000566d3e80f0db441da78c401833e17e8b50f4bb6c30580f210000000000000000000000000000000057cc3240a07955c28ea8fb374a83f6578f061cb51df69da7a44f44868277689027de63f91bde618bed5176f0000000000000000000000000000000005116fd2c8edfdd3e4ce65506c191985fb14d9dc2f6b418e0eb596fb562b4e4d4f47c1fb508c69c26503a36a6000000000000000000000000000000005d6685c08cc527f2e1bcefe0bcc3ea82f8528bf2e031d5c60000000000000000000000000000000094e474802ca2792a05d07c7a7a1497d0ec05611fc73f7226000000000000000000000000000000004bb2a980f20133f486c6cdd58cccf002623454b89484810b00000000000000000000000000000000591be3c0bf8fc333043e1b67bf2496f2996706505ad4bfb09d1a7a3191102e9f900faa10540837ba84dcbae70000000000000000000000000000000038915a905be5b42dcc2840223ce6067d09e34ce959f12145000000000000000000000000000000003b9aca0095c9c2ac72388fcc30348049b47ca1d8561941f327437ba7532c0fc6f50ca272f4ce72ef1c1c9173000000000000000000000000000000006be26880000000000000000000000000000000003c07231c0804356690d649c78ac5c31925e56966dbb45c5a000000000000000000000000000000003e41386701385f667072a2a6673f20253fc2be4ff3c7048d000000000000000000000000000000003e773600078d039719975b34ff6f163f6a131a6420238676f05bc9ec00707bb6aba7cb74162ec51fc106d518000000000000000000000000000000007a09e758e207927008fd561e64b95a42ea0d304a48da0d0d95858373baf198b15c84ef871879bece69909ad400000000000000000000243224a8fd769a9cb8004822ae848ab3278961c5a8b882568d37845a0c9e0000000000000000000000000000001df7fca0201bd295733991425feebe34ae6bdeec91bae2d94e000000000000000000000001076f0f6024e20800cde51968a41d264e45873dde3598c911b300792b00000000000000000000000000000003f3e87640bb2718db5cd62d60c1fab7968b5a2a9abaac9b4b000000000000000000000000000000022368b80084780802481458de6671a683e01bfd00d9be35d400000000000000000000000000000002faf080007a2282970b32d42c84bba38fa34fdb92d526c82200000000000000000000000000000002a0b2b18000000000000000000000000000000002056d8c4018f769bbe80dbec50bf3a65638d0b89b990f0efa16ec4f1f5c9c9086355ea107a93cb50b6f02f413cd01be3bb2db19513ffd4a89b2c1693210f19733000000000000000000000000000000007cb63ec06a31e23ad5902d5fd7b286a3e0c6412c9a1158a700000000000000000000000000000000d6d84e20f7bf989b53f44670270ccf57a9355c7acc56dde000000000000000000000000000000000b2d05e0000000000000000000000000000000000cb8cc3c08a8db4f1609ff41564f984df87f2826220de0ceabdfea24a6e1dce929f06d7c1d0bfa5542ebee8ea00000000000000000000000000000000ee5be5c04de847b8a875a3d22e4cd9474c6187d559686cd50000000000000000000000000000000165b212b62ec5130b2ee5671673a8c572c7182d4ae05aa1cb000000000000000000000000000000012a05f200000000000000000000000001c0cec2a7c4220000'
      const expectedResult: CountedOperation = {
        children: [
          {
            children: [],
            contractAddress: '0x18f769bbe80dbec50bf3a65638d0b89b990f0efa',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x4822ae848ab3278961c5a8b882568d37845a0c9e',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x1bd295733991425feebe34ae6bdeec91bae2d94e',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectETH()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xcde51968a41d264e45873dde3598c911b300792b',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xbb2718db5cd62d60c1fab7968b5a2a9abaac9b4b',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x84780802481458de6671a683e01bfd00d9be35d4',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x7a2282970b32d42c84bba38fa34fdb92d526c822',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x95858373baf198b15c84ef871879bece69909ad4',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x8a8db4f1609ff41564f984df87f2826220de0cea',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x2ec5130b2ee5671673a8c572c7182d4ae05aa1cb',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x4de847b8a875a3d22e4cd9474c6187d559686cd5',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xbdfea24a6e1dce929f06d7c1d0bfa5542ebee8ea',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x16ec4f1f5c9c9086355ea107a93cb50b6f02f413',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xf7bf989b53f44670270ccf57a9355c7acc56dde0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x6a31e23ad5902d5fd7b286a3e0c6412c9a1158a7',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xcd01be3bb2db19513ffd4a89b2c1693210f19733',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xe207927008fd561e64b95a42ea0d304a48da0d0d',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xf05bc9ec00707bb6aba7cb74162ec51fc106d518',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x8cc527f2e1bcefe0bcc3ea82f8528bf2e031d5c6',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xeb596fb562b4e4d4f47c1fb508c69c26503a36a6',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x8edfdd3e4ce65506c191985fb14d9dc2f6b418e0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xa07955c28ea8fb374a83f6578f061cb51df69da7',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xa44f44868277689027de63f91bde618bed5176f0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xf0db441da78c401833e17e8b50f4bb6c30580f21',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xb55a6a5e1b1321538e4e7a5c8d01a757fb866059',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x2ca2792a05d07c7a7a1497d0ec05611fc73f7226',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xf20133f486c6cdd58cccf002623454b89484810b',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x078d039719975b34ff6f163f6a131a6420238676',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x01385f667072a2a6673f20253fc2be4ff3c7048d',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x0804356690d649c78ac5c31925e56966dbb45c5a',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x27437ba7532c0fc6f50ca272f4ce72ef1c1c9173',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x95c9c2ac72388fcc30348049b47ca1d8561941f3',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0x5be5b42dcc2840223ce6067d09e34ce959f12145',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
          {
            children: [],
            contractAddress: '0xbf8fc333043e1b67bf2496f2996706505ad4bfb0',
            count: 1,
            id: 'id',
            level: 1,
            methodName: 'collectERC20()',
            methodSelector: '',
          },
        ],
        contractAddress: 'to',
        contractName: 'WhiteBIT sweeper',
        count: 34,
        id: 'id',
        level: 0,
        methodName: 'batch',
        methodSelector: '0xaf713566',
        methodSignature: 'batch()',
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        'to',
        EIP7821_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })

    it('should handle malformed calldata and count as 1', () => {
      const calldata =
        '0x6a7612020000000000000000000000008d29be29923b68abfdd21e541b9374737b49cdad000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004a8000000000000000000000000000000000000000000000000000000000000049048d80ff0a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000048ab0000000000000c2e074ec69a0dfb2997ba6c7d2e1e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a45ef2c7f04a9dd6923a809a49d009b308182940df46ac3a45ee16c1133f90db66596dae1fc51c57fae1b7172c39c4b7dbc1d416b9109e23826ff12a62b8e93ec1379b09c000000000000000000000000021f73d42eb58ba49ddb685dc29d3bf5c0f0373ca000000000000000000000000122eb74f9d0f1a5ed587f43d120c1c2bbdb9360b000000000000000000000000000000000000000000000000000000000000000000122eb74f9d0f1a5ed587f43d120c1c2bbdb9360b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044d5fa2b00febd3bac8f1e424ee716b30eea0b7a61f2643e67881aa1d8f9fbe37f388df12f000000000000000000000000057e52fb830318e096cd96f369f0db4b196fbfa70000000000000c2e074ec69a0dfb2997ba6c7d2e1e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a45ef2c7f04a9dd6923a809a49d009b308182940df46ac3a45ee16c1133f90db66596dae1fc0cb8e95ce88c6b83525328ae106211a4c8c75563eae4a0bdf695912b1762c0f00000000000000000000000021f73d42eb58ba49ddb685dc29d3bf5c0f0373ca000000000000000000000000122eb74f9d0f1a5ed587f43d120c1c2bbdb9360b000000000000000000000000000000000000000000000000000000000000000000122eb74f9d0f1a5ed587f43d120c1c2bbdb9360b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044d5fa2b008ceb1268da2888d730142bd19791167f36f6bb10de01510b7af83fe17767377b000000000000000000000000df2917806e30300537aeb49a7663062f4d1f2b5f0000000000000c2e074ec69a0dfb2997ba6c7d2e1e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a45ef2c7f04a9dd6923a809a49d009b308182940df46ac3a45ee16c1133f90db66596dae1fd26fb715e0d5595544fdb61e6e4de19b8960f6ec955289219df0f34287c8318600000000000000000000000021f73d42eb58ba49ddb685dc29d3bf5c0f0373ca000000000000000000000000122eb74f9d0f1a5ed587f43d120c1c2bbdb9360b000000000000000000000000000000000000000000000000000000000000000000122eb74f9d0f1a5ed587f43d120c1c2bbdb9360b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'

      const expectedResult: CountedOperation = {
        contractAddress: 'tx.to',
        contractName: 'Safe:Singleton1.3.0',
        count: 1,
        id: 'id',
        level: 0,
        methodSelector: '0x6a761202',
        methodSignature:
          'execTransaction(address,uint256,bytes,uint8,uint256,uint256,uint256,address,address,bytes)',
        methodName: 'execTransaction',
        children: [],
      }

      const counter = new RpcCounter()

      const result = counter.countUserOperations(
        calldata,
        'tx.to',
        SAFE_methods,
        () => 'id',
      )

      expect(result).toEqual(expectedResult)
    })
  })

  describe(RpcCounter.prototype.checkOperations.name, () => {
    it('should find batch operation for ERC-4337', () => {
      const mockCountedOperation = mockObject<CountedOperation>({
        level: 0,
        contractAddress: ENTRY_POINT_ADDRESS_0_6_0,
        children: [
          mockObject<CountedOperation>({
            id: 'id',
            level: 1,
            contractAddress: 'address',
            methodName: 'execute',
            methodSignature: 'executeBatch(address[],bytes[])',
            children: [
              mockObject<CountedOperation>({
                level: 2,
                contractAddress: 'address',
                methodName: 'unknown',
                methodSignature: undefined,
                children: [],
              }),
              mockObject<CountedOperation>({
                level: 2,
                contractAddress: 'address',
                methodName: 'unknown',
                methodSignature: undefined,
                children: [],
              }),
            ],
          }),
        ],
      })

      const mockTx = mockObject<EVMTransaction>({
        type: '2',
      })

      const counter = new RpcCounter()

      const result = counter.checkOperations(mockCountedOperation, mockTx)
      expect(result).toEqual({
        includesBatch: true,
        includesUnknown: false,
      })
    })

    it('should find batch operation for EIP-712', () => {
      const mockCountedOperation = mockObject<CountedOperation>({
        level: 0,
        id: 'id',
        contractAddress: 'address',
        children: [
          mockObject<CountedOperation>({
            id: 'id',
            level: 1,
            contractAddress: 'address',
            children: [],
          }),
          mockObject<CountedOperation>({
            id: 'id',
            level: 1,
            contractAddress: 'address',
            children: [],
          }),
        ],
      })

      const mockTx = mockObject<EVMTransaction>({
        type: EIP712_TX_TYPE,
      })

      const counter = new RpcCounter()

      const result = counter.checkOperations(mockCountedOperation, mockTx)
      expect(result).toEqual({
        includesBatch: true,
        includesUnknown: false,
      })
    })

    it('should find unknown operation', () => {
      const mockCountedOperation = mockObject<CountedOperation>({
        id: 'id',
        level: 0,
        contractAddress: ENTRY_POINT_ADDRESS_0_6_0,
        children: [
          mockObject<CountedOperation>({
            level: 1,
            contractAddress: 'address',
            methodName: 'unknown',
            methodSignature: undefined,
            children: [],
          }),
        ],
      })

      const mockTx = mockObject<EVMTransaction>({
        type: '2',
      })

      const counter = new RpcCounter()

      const result = counter.checkOperations(mockCountedOperation, mockTx)
      expect(result).toEqual({
        includesBatch: false,
        includesUnknown: true,
      })
    })
  })

  describe(RpcCounter.prototype.generateSmartAccountUsageForBlock.name, () => {
    it('should generate usage for block', () => {
      const mockCountedBlock = mockObject<CountedBlock>({
        transactions: [
          mockObject<CountedTransaction>({
            details: mockObject<CountedOperation>({
              contractAddress: ENTRY_POINT_ADDRESS_0_6_0,
              children: [
                mockObject<CountedOperation>({
                  contractAddress: 'address',
                  methodName: 'execute',
                  methodSignature: 'execute(address,uint256,bytes)',
                  children: [],
                }),
              ],
            }),
          }),
          mockObject<CountedTransaction>({
            details: mockObject<CountedOperation>({
              contractAddress: ENTRY_POINT_ADDRESS_0_7_0,
              children: [
                mockObject<CountedOperation>({
                  contractAddress: 'address',
                  methodName: 'execute',
                  methodSignature: 'execute(address,uint256,bytes)',
                  children: [],
                }),
              ],
            }),
          }),
          mockObject<CountedTransaction>({
            details: mockObject<CountedOperation>({
              contractAddress: ENTRY_POINT_ADDRESS_0_6_0,
              children: [
                mockObject<CountedOperation>({
                  contractAddress: 'address',
                  methodName: 'execute',
                  methodSignature: 'unknown',
                  children: [],
                }),
              ],
            }),
          }),
        ],
      })

      const counter = new RpcCounter()

      const result = counter.generateSmartAccountUsageForBlock(mockCountedBlock)
      expect(result).toEqual(
        new Map([
          ['execute(address,uint256,bytes)', 2],
          ['unknown', 1],
        ]),
      )
    })
  })
})

function createBlock(number: number, timestamp?: UnixTime): Block {
  return {
    number,
    timestamp: timestamp ?? UnixTime.now(),
    hash: `${number}.hash`,
    logsBloom: `0x${'0'.repeat(512)}`,
    transactions: [
      {
        from: 'tx1.from',
        to: 'tx1.to',
        hash: 'tx1.hash',
        data: 'tx1.data',
        type: '2',
      },
      {
        from: 'tx2.from',
        to: 'tx2.to',
        hash: 'tx2.hash',
        data: 'tx2.data',
        type: '2',
      },
    ],
  }
}

function createCountedTransaction(
  operationsCount: number,
  includesBatch = false,
): CountedTransaction {
  return {
    hash: 'tx.hash',
    operationsCount,
    type: 'ERC-4337 Entry Point 0.6.0',
    includesBatch,
    from: 'tx.from',
  }
}
