import { ProjectId, UnixTime } from '@l2beat/shared-pure'
import { expect, mockFn, mockObject } from 'earl'

import { RpcClient } from '../../../peripherals/rpcclient/RpcClient'
import { LivenessRepository } from '../../tracked-txs/modules/liveness/repositories/LivenessRepository'
import { ScrollFinalityAnalyzer } from './ScrollFinalityAnalyzer'

describe(ScrollFinalityAnalyzer.name, () => {
  describe(ScrollFinalityAnalyzer.prototype.getFinality.name, () => {
    it('should return timestamp differences between l1 and l2 blocks', async () => {
      const TX_HASH =
        '0xd9ac85a5a989aaa9e238065f5a3e7f0d59f4836ab0796c2a356bb52384190b80'
      const L1_TIMESTAMP = 1800000000
      const L2_TIMESTAMP = 1711013954

      const projectId = ProjectId('scroll')
      const rpcClient = mockObject<RpcClient>({
        getTransaction: mockFn().resolvesTo({
          data: mockBytesResponse,
        }),
      })
      const livenessRepository = mockObject<LivenessRepository>({})

      const analyzer = new ScrollFinalityAnalyzer(
        rpcClient,
        livenessRepository,
        projectId,
      )

      const result = await analyzer.getFinality({
        txHash: TX_HASH,
        timestamp: new UnixTime(L1_TIMESTAMP),
      })

      expect(result).toEqual([L1_TIMESTAMP - L2_TIMESTAMP])
    })
  })
})

/**
 * Slice of actual transcation under hash `0xd9ac85a5a989aaa9e238065f5a3e7f0d59f4836ab0796c2a356bb52384190b80`
 * Original transaction contains 12 block contexts with 12 blocks.
 * For the sake of testing, we only care about the single block context data has been reduced to.
 * Version, Parent header and bitmap have been preserved.
 *
 * Block preserved: 4308974
 * Timestamp of preserved block: 1711013954
 * */
const mockBytesResponse =
  '0x1325aca00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000001bc0000000000000000000000000000000000000000000000000000000000000005900000000000001cc1500000000000000000000000000035d8560758e9dc1e56d90402c15dc4f17da766502801add88c38932992069005a8efe517978056fc4e7867fbeacfd6f9c380060da0fc3137fd3e913d3a8c89a608c1b00000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001a4a01000000000041bfee0000000065fc00420000000000000000000000000000000000000000000000000000000000000000000000000098968000130000000000b5f8b334841dcd65008304b0c894ec53c830f4444a8a56455c6836b5d2aa794289aa87e198e9df3cc000b844f2b9fdb8000000000000000000000000274c3795dadfebf562932992bf241ae087e0a98c00000000000000000000000000000000000000000000000000e198e9df3cc00083104ec4a054e39d94dbb4ad0b9ca01fdfe6faffe2eb52ab3a04927523293f37c6537b7c2da0184fad9fbf7332bb24e2a1b5f56ed6fbe8c4b8bf285bd33f6abcbf87b8bebede000000aef8ac2c842cb41780830113af9487627c7e586441eef9ee3c28b66662e897513f3380b84447e7ef2400000000000000000000000006efdbff2a14a7c8e15944d1f4a48f9f95f663a4000000000000000000000000000000000000000000000000000000008e74818083104ec4a0bcad63291ae75031db31a92cd293fc3354c2acf4597330b0275826365db0f5d0a0689d7cb46b06f4e7961b5b8814b1f3c480e765a39af74e9680f01d91f7c19d07000000f5f8f38223d18422bc0f3083065e9a94e124232389cce06ede97539700a9d27c1007bf2680b889f0cacc1af55bec9cafdbe8730f096aa55dad6d22d44099df530000000000000000000000000000000000000406efdbff2a14a7c8e15944d1f4a48f9f95f663a4061206887b414d34ba20ae7ed5378380682f22071d08c26905c59be1a7ea32d1f257e302401ec9a1401c52000000e8d4a51000000c9852d643417f2710271f26c5271a0300270f26f283104ec4a0086e53e4fea3d2d88a9fbff6b75c84191a29f05ca65ebec41f1a10fe51489036a0448e80044b5d4437244c5b178407c6d5ea972ab6b775cfda7b58fe38d1140b2f000000b5f8b30f8420c855808302f2e194ec53c830f4444a8a56455c6836b5d2aa794289aa871a1a0ebd2a3000b844f2b9fdb8000000000000000000000000274c3795dadfebf562932992bf241ae087e0a98c000000000000000000000000000000000000000000000000001a1a0ebd2a300083104ec4a0e6992c0835c4043a2a4803f385e1fea4e35d1cf6018577e1a0305bf352cce374a067c94e394343e70e3c60abbb2d8bfbb9ab66792dc9677de2e8694b00c77e7518000001d7f901d416841f4add40830319ae94734583f62bb6ace3c9ba9bd5a53143ca2ce8c55a871de67f7416a24cb901642646478b000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000000000000000000000000000001de67f7416a24c00000000000000000000000006efdbff2a14a7c8e15944d1f4a48f9f95f663a40000000000000000000000000000000000000000000000000000000001bf5c70000000000000000000000000b77f8544403a2af3f70199b609e7b272c4edde0b00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000700301ffff0201b6dacf7d94d871651a38e23ba8e4028ba604a605530000000000000000000000000000000000000404530000000000000000000000000000000000000400b6dacf7d94d871651a38e23ba8e4028ba604a60500b77f8544403a2af3f70199b609e7b272c4edde0b000bb80000000000000000000000000000000083104ec3a0f40b5e9ae3305e8f9ca504fad877828288a7a6ee005bc55c23a24a888506ea5ca04c588571a54505ae8d84b38e1d7012c156d20b963cb2ba852821bac2b740ea0d00000177f901740c841f4add4083045ef194aa111c62cdeef205f70e6722d1e22274274ec12f87112a9780814ce1b9010467ffb66a0000000000000000000000000000000000000000000000000000000001030d0d0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000d63b256fbbb268d68a7925206350e4ba5959e6050000000000000000000000000000000000000000000000000000018e607338a20000000000000000000000000000000000000000000000000000000000000001000000000000000000000000530000000000000000000000000000000000000400000000000000000000000006efdbff2a14a7c8e15944d1f4a48f9f95f663a4000000000000000000000000000000000000000000000000000000000000000083104ec3a0ec4b6e614feedf1adb250a6a9194a32ff24e8703d879775d24949ea3d0241536a06e8b1d9885aef85072325d56ec7c02c8fdb4e1b9e7a6a0f9cdb893b25f4ad397000000adf8ab38841e65fb8082eb869406efdbff2a14a7c8e15944d1f4a48f9f95f663a480b844095ea7b3000000000000000000000000f04bf4e3e8157ba5b91bfda16e21be770e7ac79000000000000000000000000000000000000000000000000000000000000aae6083104ec4a0e54fec03773f016053307dbb9d5db1991e35c36d92f964543cc3a8c7f5467e51a02d9edee6130acf11c1aa9ae8005ecc4d4a2cc06e9bb2b1904d068642b51905bc000002d7f902d412841e65fb808303b2d69480e38291e06339d10aab483c65695d004dbd5c69870c6f3b40b6c000b902642cc4081e00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000b975d00000000000000000000000000000000000000000000000000000000065fc2f110000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c6f3b40b6c00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000814a23b053fd0f102aeeda0459215c2444799c70000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000006000000000000000000000000053000000000000000000000000000000000000040000000000000000000000006fef340691a7c5f68f8e6971baf0eef85bfa1e520000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000083104ec3a047e1e64458356c37a07323222e13fe7b12d8c61bb69d1601865d9d6807de0bbba07088fdccf4ad4be181ddf4082a892b7c838d38809d0aeeedbcd724cabf23b9cf0000006cf86a0c841dcd65008255f094e10add2ad591a7ac3ca46788a06290de017b9fb48084632a9a5283104ec4a0864790f462b5fb96afcd6b7ac2b628c2a07b28ccc29c0c87f3803ae91d5120ada01616e8c39d33bf598b38012ae54528477e262e59ce3b95ea0535235f2d60f5bc000000aef8ac81cd841dcd650082eb929406efdbff2a14a7c8e15944d1f4a48f9f95f663a480b844095ea7b3000000000000000000000000aaaaaaaacb71bf2c8cae522ea5fa455571a74106000000000000000000000000000000000000000000000000000000001595de0583104ec4a0844b1449620a4c82655fde10e3f289aaa605db2e7725b931c274699657ba9b07a01787673a8d113eabfbe4980b488cd1bdb2888f99856faaff2e8d0738560e2c6a000002d0f902cd08841dcd6500830392d4942db0afd0045f3518c77ec6591a542e326befd3d780b90264ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000012475ceafe6000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000575d870000000000000000000000000000000000000000000000000005acfc96b269c90000000000000000000000000000000000000000000000000000000065fc0277000000000000000000000000000000000000000000000000000000000000002b06efdbff2a14a7c8e15944d1f4a48f9f95f663a4000bb8530000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004449404b7c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009783ec1092bd565f9d73361eaffb089e38cc1790000000000000000000000000000000000000000000000000000000083104ec3a0fb69dd47200051fbd60f13f7225ba4834100f4cfa2a05c9e290ea3facf729b91a0423828c9648445758904284f723dc5bc52cf5679f6e6c879f36ed0f2c2f5335d00000072f8700a841dcd650082cab49453000000000000000000000000000000000000048609184e72a00084d0e30db083104ec3a01ee3e1bfb374db0e73d6ee4d6416748e427353e5697512d158fa668ee3dc5ac7a046513fb2ec48b3260fb7f4a2637d01e95080c88f6c3f33f2edb96011225270eb000000d4f8d213841dcd6500830493e094ff75a4b698e3ec95e608ac0f22a03b8368e05f5d86347a5400e800b864474cf53d00000000000000000000000011fcfe756c05ad438e312a7fd934381537d3cffe000000000000000000000000173dcdec558bd8cab6d04681635cb5b9265be475000000000000000000000000000000000000000000000000000000000000000083104ec4a01a0628e4ce53858875ebe7424ceba08004d2f3ef496bad1272e8a62290e9cab9a0061ebc86d2776901ade6566217bfd6ebf819aec03fc188daa6c35d8e28163bff000002b7f902b40b841dcd6500830599f8942db0afd0045f3518c77ec6591a542e326befd3d7870125c44c433000b90244ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000014475ceafe6000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000a028551d4890d28b379c56d681c5037df997ba44000000000000000000000000000000000000000000000000000125c44c433000000000000000000000000000000000000000000000000000000000000011937d0000000000000000000000000000000000000000000000000000000065fc0275000000000000000000000000000000000000000000000000000000000000004253000000000000000000000000000000000000040001f4f55bec9cafdbe8730f096aa55dad6d22d44099df0001f406efdbff2a14a7c8e15944d1f4a48f9f95f663a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a0000000000000000000000000000000000000000000000000000000083104ec3a0fa358c9e74fc4d7ebc8c90ba8d80d42f350482b3c363b0cc04187ca91316affba0092d43e551bf5b79e0946f5a2f78d51e5fccfb1eba2058fb6e380b04e00a72d8000002b7f902b405841dcd65008306878a942db0afd0045f3518c77ec6591a542e326befd3d78758d15e17628000b90244ac9650d800000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000014475ceafe6000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000543648aebed8188f6f10c706663433de432931980000000000000000000000000000000000000000000000000058d15e1762800000000000000000000000000000000000000000000000000000000000054c53f70000000000000000000000000000000000000000000000000000000065fc0279000000000000000000000000000000000000000000000000000000000000004253000000000000000000000000000000000000040001f4f55bec9cafdbe8730f096aa55dad6d22d44099df0001f406efdbff2a14a7c8e15944d1f4a48f9f95f663a400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412210e8a0000000000000000000000000000000000000000000000000000000083104ec4a0d7fbc6a0d029f07839df14875b023dd6aee5b7ae5a2f6c7748c02bdf398d6c23a077f0b33033b643e5c954cfb95bf86fb00025f415af261a368d477b64ff00517f000000b6f8b41a841dcd65008302f2f394ec53c830f4444a8a56455c6836b5d2aa794289aa8809d0e255e2a92000b844f2b9fdb8000000000000000000000000274c3795dadfebf562932992bf241ae087e0a98c00000000000000000000000000000000000000000000000009d0e255e2a9200083104ec3a00fd18acc4ef3860849b62c245982e294c7a13c23d77cf6d8d30c8891c09cdaa6a058282c3e5ec7648736e97e6545d0baea58e6237eaa780c20ffdd65f42ce3392200000072f8702c841dcd65008302067194b6fd349bdbfb86c55cef803178de73bc0d699462862d79883d2000841249c58b83104ec4a0131d7a9014a7c7ad5a47aca5cd3db137b0cb1dcefb1df3d36c708de882c514f49feaed44825752bff1988a378220b27bc7df89451f0aaa20e003f1769bc1492000000390f9038d13841dcd65008304a768944e998615ad430c1ca46a69d813ede6eb3ec55edb80b90324301a3720000000000000000000000000f55bec9cafdbe8730f096aa55dad6d22d44099df00000000000000000000000006efdbff2a14a7c8e15944d1f4a48f9f95f663a4000000000000000000000000000000000000000000000000000000005246009d0000000000000000000000000000000000000000000000000000000051d3a1d4000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000065fc04d00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000716fcc67dca500a91b4a28c9255262c398d8f971000000000000000000000000000000000000000000000000000000000000000100000000000000000000000025603aedf9b3ebf600a6058eb6be7b97349c002f000000000000000000000000000000000000000000000000000000000000000200000000000000000000000025603aedf9b3ebf600a6058eb6be7b97349c002f0000000000000000000000004e998615ad430c1ca46a69d813ede6eb3ec55edb000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000006c1c420c04f4d563d6588a97693af902b87be5f1000000000000000000000000000000000000000000000000000000000000000083104ec4a06d6178725c6627e444d5cd235d07686b60490ae2a2e6380072e8c9e79c1751d1a06879fe8f8215f271fd4199e6c941276ea2e121a591782b3402d40785fd52c6db0000008cf88a13841dcd650082faca94530000000000000000000000000000000000000480a42e1a7d4d00000000000000000000000000000000000000000000000002c68af0bb14000083104ec4a003b626eba341baffdf6627373d27ddded603b523f194794c4e537f46d290ae9ba018e20ac4e59fe0fe42811f0ad92144ee3acaa522102004789ef69ae484703d4a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000'
