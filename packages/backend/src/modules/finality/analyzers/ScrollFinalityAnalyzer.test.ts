import { ProjectId, UnixTime } from '@l2beat/shared-pure'
import { expect, mockFn, mockObject } from 'earl'

import { Database } from '@l2beat/database'
import { RpcClient } from '../../../peripherals/rpcclient/RpcClient'
import { ScrollFinalityAnalyzer } from './ScrollFinalityAnalyzer'

describe(ScrollFinalityAnalyzer.name, () => {
  describe(ScrollFinalityAnalyzer.prototype.analyze.name, () => {
    it.only('should return timestamp differences between l1 and l2 blocks', async () => {
      const TX_HASH =
        '0xd9ac85a5a989aaa9e238065f5a3e7f0d59f4836ab0796c2a356bb52384190b80'
      const L1_TIMESTAMP = 1724743271
      const L2_TIMESTAMPS = [
        1724743030, 1724743033, 1724743036, 1724743039, 1724743042, 1724743045,
        1724743048, 1724743051, 1724743054, 1724743057, 1724743060, 1724743063,
        1724743066, 1724743067, 1724743070, 1724743073, 1724743076, 1724743079,
        1724743082, 1724743085, 1724743088, 1724743091, 1724743094, 1724743097,
        1724743100, 1724743103, 1724743106, 1724743109, 1724743112, 1724743115,
        1724743118, 1724743121, 1724743124, 1724743127, 1724743130, 1724743133,
        1724743136, 1724743138, 1724743141, 1724743144, 1724743147, 1724743150,
        1724743153, 1724743156, 1724743159, 1724743162, 1724743165, 1724743168,
        1724743171, 1724743174, 1724743177, 1724743180, 1724743183, 1724743186,
        1724743189, 1724743192, 1724743195, 1724743198, 1724743201, 1724743204,
        1724743207, 1724743210, 1724743213, 1724743216, 1724743218, 1724743221,
        1724743224,
      ]

      const projectId = ProjectId('scroll')
      const rpcClient = mockObject<RpcClient>({
        getTransaction: mockFn().resolvesTo({
          data: mockBytesResponse,
        }),
      })

      const analyzer = new ScrollFinalityAnalyzer(
        rpcClient,
        mockObject<Database>(),
        projectId,
      )

      const result = await analyzer.analyze({
        txHash: TX_HASH,
        timestamp: new UnixTime(L1_TIMESTAMP),
      })

      expect(result).toEqual(
        L2_TIMESTAMPS.map((L2_TIMESTAMP) => L1_TIMESTAMP - L2_TIMESTAMP),
      )
    })
  })
})

/**
 * Slice of actual transcation under hash `0x8a45e125e2571ee341bafdb66ea3da23fb340a4f95e856edf76b6641b8743fb3`
 * Original transaction contains 67 block contexts with 67 blocks.
 * */
const mockBytesResponse =
  '0x86b053a9000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000001dc00000000000000000000000000000000000000000000000000000000000001de000000000000000000000000000000000000000000000000000000000000000c103000000000004bd8b000000000000000000000000000e2fd0e329fa719deef9ba224b883f93bb9846929c887e5a37682df468bcaee3d7f4a801c28513b90b3771407493b074f55a91e9d8f4f6b66f652fdc43e4ac6447b69c2fd5a512824c28ed16bdc84489f7a779b98c42475b5e32703748454d8174956c0000000066cd7d7342d2db726b4d5cbbac242f44ce885fb022e67b12fcc2e8a3bd3483005661e9896408c0f8f24d06be962467dfa39469bee19f70c2a8bacd933ba906376d2b8aed00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002d00000000000000000000000000000000000000000000000000000000000005a0000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000006a0000000000000000000000000000000000000000000000000000000000000074000000000000000000000000000000000000000000000000000000000000007a0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008a0000000000000000000000000000000000000000000000000000000000000094000000000000000000000000000000000000000000000000000000000000009a00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000ae00000000000000000000000000000000000000000000000000000000000000b800000000000000000000000000000000000000000000000000000000000000be00000000000000000000000000000000000000000000000000000000000000c400000000000000000000000000000000000000000000000000000000000000ce00000000000000000000000000000000000000000000000000000000000000dc00000000000000000000000000000000000000000000000000000000000000e600000000000000000000000000000000000000000000000000000000000000f000000000000000000000000000000000000000000000000000000000000000f60000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000010a00000000000000000000000000000000000000000000000000000000000001100000000000000000000000000000000000000000000000000000000000000116000000000000000000000000000000000000000000000000000000000000011c0000000000000000000000000000000000000000000000000000000000000122000000000000000000000000000000000000000000000000000000000000012c00000000000000000000000000000000000000000000000000000000000001320000000000000000000000000000000000000000000000000000000000000138000000000000000000000000000000000000000000000000000000000000013e0000000000000000000000000000000000000000000000000000000000000148000000000000000000000000000000000000000000000000000000000000014e000000000000000000000000000000000000000000000000000000000000015c0000000000000000000000000000000000000000000000000000000000000166000000000000000000000000000000000000000000000000000000000000016c00000000000000000000000000000000000000000000000000000000000001720000000000000000000000000000000000000000000000000000000000000178000000000000000000000000000000000000000000000000000000000000017e0000000000000000000000000000000000000000000000000000000000000184000000000000000000000000000000000000000000000000000000000000018e0000000000000000000000000000000000000000000000000000000000000194000000000000000000000000000000000000000000000000000000000000019a00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001aa00000000000000000000000000000000000000000000000000000000000001b000000000000000000000000000000000000000000000000000000000000001ba00000000000000000000000000000000000000000000000000000000000000079020000000000856c650000000066cd7d7600000000000000000000000000000000000000000000000000000000023a310a0000000000989680000400000000000000856c660000000066cd7d7900000000000000000000000000000000000000000000000000000000023a310a00000000009896800005000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c670000000066cd7d7c00000000000000000000000000000000000000000000000000000000023a310a0000000000989680000c00000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c680000000066cd7d7f00000000000000000000000000000000000000000000000000000000023c52db0000000000989680000600000000000000856c690000000066cd7d8200000000000000000000000000000000000000000000000000000000023c52db00000000009896800004000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c6a0000000066cd7d8500000000000000000000000000000000000000000000000000000000023c52db0000000000989680000b0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c6b0000000066cd7d8800000000000000000000000000000000000000000000000000000000023c52db0000000000989680000900000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c6c0000000066cd7d8b00000000000000000000000000000000000000000000000000000000023c52db0000000000989680000d00000000000000856c6d0000000066cd7d8e00000000000000000000000000000000000000000000000000000000023c52db000000000098968000060000000000000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c6e0000000066cd7d9100000000000000000000000000000000000000000000000000000000023c52db0000000000989680000700000000000000856c6f0000000066cd7d9400000000000000000000000000000000000000000000000000000000023c52db00000000009896800005000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c700000000066cd7d9700000000000000000000000000000000000000000000000000000000023c52db0000000000989680000a0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c710000000066cd7d9a00000000000000000000000000000000000000000000000000000000023c52db0000000000989680000b000000000000000000000000000000000000000000000000000000000000000000000000b5030000000000856c720000000066cd7d9b00000000000000000000000000000000000000000000000000000000023c52db0000000000989680000700000000000000856c730000000066cd7d9e00000000000000000000000000000000000000000000000000000000023c52db0000000000989680000700000000000000856c740000000066cd7da100000000000000000000000000000000000000000000000000000000023c52db00000000009896800003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c750000000066cd7da400000000000000000000000000000000000000000000000000000000023c52db0000000000989680000700000000000000856c760000000066cd7da700000000000000000000000000000000000000000000000000000000023c52db00000000009896800007000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c770000000066cd7daa00000000000000000000000000000000000000000000000000000000023c52db000000000098968000080000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c780000000066cd7dad00000000000000000000000000000000000000000000000000000000023c52db0000000000989680000a00000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c790000000066cd7db000000000000000000000000000000000000000000000000000000000023c52db0000000000989680000a00000000000000856c7a0000000066cd7db300000000000000000000000000000000000000000000000000000000023c52db0000000000989680000800000000000000000000000000000000000000000000000000000000000000000000000000000000b5030000000000856c7b0000000066cd7db600000000000000000000000000000000000000000000000000000000023c52db0000000000989680000600000000000000856c7c0000000066cd7db900000000000000000000000000000000000000000000000000000000023c52db0000000000989680000900000000000000856c7d0000000066cd7dbc0000000000000000000000000000000000000000000000000000000002407ec100000000009896800003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c7e0000000066cd7dbf0000000000000000000000000000000000000000000000000000000002407ec10000000000989680000600000000000000856c7f0000000066cd7dc20000000000000000000000000000000000000000000000000000000002407ec1000000000098968000080000000000000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c800000000066cd7dc500000000000000000000000000000000000000000000000000000000023d90550000000000989680000900000000000000856c810000000066cd7dc800000000000000000000000000000000000000000000000000000000023d905500000000009896800007000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c820000000066cd7dcb00000000000000000000000000000000000000000000000000000000023d90550000000000989680000800000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c830000000066cd7dce00000000000000000000000000000000000000000000000000000000023d90550000000000989680000700000000000000856c840000000066cd7dd100000000000000000000000000000000000000000000000000000000023d9055000000000098968000070000000000000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c850000000066cd7dd400000000000000000000000000000000000000000000000000000000023d90550000000000989680000700000000000000856c860000000066cd7dd700000000000000000000000000000000000000000000000000000000023d905500000000009896800005000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c870000000066cd7dda00000000000000000000000000000000000000000000000000000000023acfa80000000000989680000d0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c880000000066cd7ddd00000000000000000000000000000000000000000000000000000000023acfa8000000000098968000090000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c890000000066cd7de000000000000000000000000000000000000000000000000000000000023acfa80000000000989680000a0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c8a0000000066cd7de200000000000000000000000000000000000000000000000000000000023acfa80000000000989680000500000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c8b0000000066cd7de500000000000000000000000000000000000000000000000000000000023acfa80000000000989680000700000000000000856c8c0000000066cd7de800000000000000000000000000000000000000000000000000000000023acfa800000000009896800008000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c8d0000000066cd7deb00000000000000000000000000000000000000000000000000000000023acfa80000000000989680000c0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c8e0000000066cd7dee00000000000000000000000000000000000000000000000000000000023acfa80000000000989680000c0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c8f0000000066cd7df100000000000000000000000000000000000000000000000000000000023acfa80000000000989680000e00000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c900000000066cd7df400000000000000000000000000000000000000000000000000000000023acfa80000000000989680000900000000000000856c910000000066cd7df70000000000000000000000000000000000000000000000000000000002411c8c0000000000989680000a000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c920000000066cd7dfa0000000000000000000000000000000000000000000000000000000002411c8c0000000000989680000b000000000000000000000000000000000000000000000000000000000000000000000000b5030000000000856c930000000066cd7dfd0000000000000000000000000000000000000000000000000000000002411c8c0000000000989680000400000000000000856c940000000066cd7e000000000000000000000000000000000000000000000000000000000002411c8c0000000000989680000400000000000000856c950000000066cd7e0300000000000000000000000000000000000000000000000000000000023e852e00000000009896800003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c960000000066cd7e0600000000000000000000000000000000000000000000000000000000023e852e0000000000989680000a00000000000000856c970000000066cd7e0900000000000000000000000000000000000000000000000000000000023e852e00000000009896800008000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c980000000066cd7e0c000000000000000000000000000000000000000000000000000000000243629b000000000098968000080000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c990000000066cd7e0f000000000000000000000000000000000000000000000000000000000243629b0000000000989680000d0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c9a0000000066cd7e12000000000000000000000000000000000000000000000000000000000243629b0000000000989680000e0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c9b0000000066cd7e1500000000000000000000000000000000000000000000000000000000023e0088000000000098968000090000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c9c0000000066cd7e1800000000000000000000000000000000000000000000000000000000023e00880000000000989680000d00000000000000000000000000000000000000000000000000000000000000000000000079020000000000856c9d0000000066cd7e1b00000000000000000000000000000000000000000000000000000000023e00880000000000989680000800000000000000856c9e0000000066cd7e1e00000000000000000000000000000000000000000000000000000000023e008800000000009896800005000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856c9f0000000066cd7e2100000000000000000000000000000000000000000000000000000000023e0088000000000098968000080000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856ca00000000066cd7e2400000000000000000000000000000000000000000000000000000000023e00880000000000989680000d0000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856ca10000000066cd7e2700000000000000000000000000000000000000000000000000000000023e00880000000000989680000c00000000000000000000000000000000000000000000000000000000000000000000000079020000000000856ca20000000066cd7e2a000000000000000000000000000000000000000000000000000000000241410a0000000000989680000700000000000000856ca30000000066cd7e2d000000000000000000000000000000000000000000000000000000000241410a0000000000989680000a000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856ca40000000066cd7e30000000000000000000000000000000000000000000000000000000000241410a0000000000989680000c00000000000000000000000000000000000000000000000000000000000000000000000079020000000000856ca50000000066cd7e32000000000000000000000000000000000000000000000000000000000241410a0000000000989680000700000000000000856ca60000000066cd7e35000000000000000000000000000000000000000000000000000000000241410a00000000009896800008000000000000000000000000000000000000000000000000000000000000000000000000000000003d010000000000856ca70000000066cd7e38000000000000000000000000000000000000000000000000000000000241410a0000000000989680000f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00dae831f014601b05e784d14272025a406f19f70467d705156a3d7e5bda11acb5d42c2cc9c8557121b2de355b6707c946c27c4684b6427b04618d115adfac237ab1ca23774ccf3b2bce58a13f1811022541eccc02294103e56d18818aae77a0e9575353a6b37a8cfa49ea3429c3f351482355c4f17870e1c5e8761213ec52ec0940a7af8f616f425e23bd35d54fc0b61df6048ca62b2d18935a06823996ca9b8'
