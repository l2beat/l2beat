name: Smoke Test (MQ)

on:
  merge_group:

jobs:
  config-smoke-test:
    name: Config smoke test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      HEROKU_ORGANIZATION: ${{ vars.HEROKU_ORG }}
      HEROKU_API_KEY: ${{ secrets.HEROKU_TOKEN }}
      COOLIFY_SERVER: ${{ secrets.COOLIFY_SERVER }}
      COOLIFY_API_KEY: ${{ secrets.COOLIFY_RO_API_KEY }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install
        working-directory: packages/backend

      - name: Build packages
        run: pnpm build:dependencies
        working-directory: packages/backend

      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh

      - name: Install and setup Coolify CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/coollabsio/coolify-cli/main/scripts/install.sh | bash
          coolify context add l2beat "$COOLIFY_SERVER" "$COOLIFY_API_KEY"
          coolify context use l2beat

      # Backend
      - name: Pull staging backend configuration
        run: coolify app env list "$COOLIFY_APP_ID" -s --format json | jq -r '.[]|(.key + "=" + .real_value)' > .env
        working-directory: packages/backend
        env:
          COOLIFY_APP_ID: ${{ secrets.COOLIFY_BACKEND_STAGING_ID }}

      # PORT variable is not present inside the dump and is assigned by Heroku at deployment time
      - name: Fill PORT variable
        run: echo "PORT=3000" >> .env
        working-directory: packages/backend

      - name: Run staging backend smoke test
        run: pnpm test:config
        working-directory: packages/backend

      - name: Pull production backend configuration
        run: heroku config -a l2beat-production --shell > .env
        working-directory: packages/backend

      - name: Fill PORT variable
        run: echo "PORT=3000" >> .env
        working-directory: packages/backend

      - name: Run production backend smoke test
        run: pnpm test:config
        working-directory: packages/backend

      # Update Monitor
      - name: Pull staging update monitor configuration
        run: coolify app env list "$COOLIFY_APP_ID" -s --format json | jq -r '.[]|(.key + "=" + .real_value)' > .env
        working-directory: packages/backend
        env:
          COOLIFY_APP_ID: ${{ secrets.COOLIFY_UM_STAGING_ID }}

      - name: Fill PORT variable
        run: echo "PORT=3000" >> .env
        working-directory: packages/backend

      - name: Run staging update monitor smoke test
        run: pnpm test:config
        working-directory: packages/backend

      - name: Pull production update monitor configuration
        run: heroku config -a l2beat-update-monitor-prod --shell > .env
        working-directory: packages/backend

      - name: Fill PORT variable
        run: echo "PORT=3000" >> .env
        working-directory: packages/backend

      - name: Run production update monitor smoke test
        run: pnpm test:config
        working-directory: packages/backend

      # L2BEAT TVS
      - name: Pull staging l2beat TVS configuration
        run: coolify app env list "$COOLIFY_APP_ID" -s --format json | jq -r '.[]|(.key + "=" + .real_value)' > .env
        working-directory: packages/backend
        env:
          COOLIFY_APP_ID: ${{ secrets.COOLIFY_TVS_STAGING_ID }}

      - name: Fill PORT variable
        run: echo "PORT=3000" >> .env
        working-directory: packages/backend

      - name: Run staging l2beat TVS smoke test
        run: pnpm test:config
        working-directory: packages/backend

      - name: Pull production l2beat TVS configuration
        run: heroku config -a l2beat-tvs-production --shell > .env
        working-directory: packages/backend

      - name: Fill PORT variable
        run: echo "PORT=3000" >> .env
        working-directory: packages/backend

      - name: Run production l2beat TVS smoke test
        run: pnpm test:config
        working-directory: packages/backend
