name: Diff

on:
  pull_request:

permissions:
  pages: write # For GitHub Pages deployment
  id-token: write # For authentication with GitHub Pages
  pull-requests: write # For commenting on PRs

jobs:
  config-diff:
    runs-on: ubuntu-latest
    env:
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
      TURBO_TEAM: ${{ vars.TURBO_TEAM }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Find merge-base between PR and main
        run: echo "MERGE_BASE_SHA=$(git merge-base ${{ github.event.pull_request.head.sha }} origin/main)" >> $GITHUB_ENV
      
      - name: Checkout code (main)
        run: git checkout $MERGE_BASE_SHA

      - name: Install dependencies (main)
        run: pnpm install

      - name: Build config (main)
        run: pnpm build:dependencies

      - name: Save database (main)
        run: |
          mkdir -p /tmp/compare/main
          cp ./packages/config/build/db.sqlite /tmp/compare/main/db.sqlite
          git rev-parse HEAD > /tmp/compare/main/commit

      - name: Checkout code (PR)
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          clean: true

      - name: Install dependencies (PR)
        run: pnpm install

      - name: Build config (PR)
        run: pnpm build:dependencies

      - name: Save database (PR)
        run: |
          mkdir -p /tmp/compare/pr
          cp ./packages/config/build/db.sqlite /tmp/compare/pr/db.sqlite
          git rev-parse HEAD > /tmp/compare/pr/commit

      - name: Generate schema diff HTML report
        id: diff
        run: |
          cd packages/config
          pnpm diff /tmp/compare/diff.html
          echo "has_changes=$(cat /tmp/compare/diff.html | grep -c "No changes detected" || true)" >> $GITHUB_OUTPUT

      - name: Setup GitHub Pages artifact
        if: steps.diff.outputs.has_changes != '1'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPORT_DIR="pages-output/pr-$PR_NUMBER"
          mkdir -p "$REPORT_DIR"
          cp /tmp/compare/diff.html "$REPORT_DIR/index.html"

      - name: Upload GitHub Pages artifact
        if: steps.diff.outputs.has_changes != '1'
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages-output

      - name: Deploy to GitHub Pages
        id: deployment
        if: steps.diff.outputs.has_changes != '1'
        uses: actions/deploy-pages@v4

      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Config Changes Report'

      - name: Get current timestamp
        id: timestamp
        run: echo "value=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create or Update Comment (Changes Detected)
        if: steps.diff.outputs.has_changes != '1'
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Config Changes Report
            
            Config changes have been detected between main and this PR.
            
            [View Full Report](${{ steps.deployment.outputs.page_url }}/pr-${{ github.event.pull_request.number }})
            
            *Last updated: ${{ steps.timestamp.outputs.value }}*
          edit-mode: replace
          
      - name: Create or Update Comment (No Changes)
        if: steps.diff.outputs.has_changes == '1'
        uses: peter-evans/create-or-update-comment@v2
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Config Changes Report
            
            No schema changes detected between main and this PR.
            
            *Last updated: ${{ steps.timestamp.outputs.value }}*
          edit-mode: replace